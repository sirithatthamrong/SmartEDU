<% content_for :title, "Classroom #{@classroom.class_id}" %>

<h1 class="text-3xl font-bold text-center mb-6 mt-4">Students in Classroom <%= @classroom.class_id %></h1>
<div class="mx-auto bg-white p-6 rounded-lg shadow">
  <%= form_with url: attendances_path, method: :post, remote: true do %>
    <table>
      <thead>
      <tr>
        <th class="text-gray-1000 text-l">ID</th>
        <th class="text-gray-1000 text-l">Name</th>
        <th class="text-gray-1000 text-l">Check-In</th>
      </tr>
      </thead>
      <tbody>
      <% @students.each do |student| %>
        <tr class="text-lg font-medium" data-content="<%= student.name %>">
          <td class="text-gray-800"><%= student.id %></td>
          <td class="text-gray-800"><%= highlight(student.name, params.dig(:q, :name_cont)) %></td>
          <td>
            <button class="check-in-btn btn btn-m" data-student-id="<%= student.id %>">
              Check-In
            </button>
          </td>
        </tr>
      <% end %>
      </tbody>
    </table>
  <% end %>
</div>

<div class="text-center mt-6">
  <%= link_to "Back to Classrooms", by_grade_classrooms_path(@classroom.class_id.first), class: "text-blue-500 hover:underline" %>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".check-in-btn").forEach(button => {
            let studentId = button.dataset.studentId;

            // First, check if the student has already checked in today
            checkIfAlreadyCheckedIn(studentId).then(isCheckedIn => {
                if (isCheckedIn) {
                    button.classList.add("checked-in");
                    button.style.backgroundColor = "lightgreen";
                    button.textContent = "Checked In";
                } else {
                    button.classList.remove("checked-in");
                    button.style.backgroundColor = "";
                    button.textContent = "Check-In";
                }
            });

            button.addEventListener("click", async function (event) {
                event.preventDefault();
                let btn = event.target;
                let checkedIn = btn.classList.contains("checked-in");

                if (!checkedIn) {
                    // Attempt to check in (POST)
                    try {
                        let response = await fetch("<%= attendances_path %>", {
                            method: "POST",
                            headers: {
                                "X-CSRF-Token": document.querySelector("meta[name='csrf-token']").content,
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({student_id: studentId})
                        });

                        let result = await response.json();

                        if (response.ok && result.status === "success") {
                            btn.classList.add("checked-in");
                            btn.style.backgroundColor = "lightgreen";
                            btn.textContent = "Checked In";
                            console.log("Check-in successful");
                        } else if (result.status === "already_checked_in") {
                            console.log("Already checked in today.");
                            btn.classList.add("checked-in");
                            btn.style.backgroundColor = "lightgreen";
                            btn.textContent = "Checked In";
                        } else {
                            console.error("Check-in failed:", await response.text());
                        }
                    } catch (error) {
                        console.error("Check-in request error:", error);
                    }
                }
            });
        });
    });

    // Function to check if the student has already checked in today
    async function checkIfAlreadyCheckedIn(studentId) {
        try {
            let response = await fetch(`/attendances/${studentId}/check_if_checked_in`, {
                method: "GET",
                headers: {
                    "X-CSRF-Token": document.querySelector("meta[name='csrf-token']").content
                }
            });

            let result = await response.json();
            return result.checked_in; // Expecting { checked_in: true } or { checked_in: false }
        } catch (error) {
            console.error("Error checking check-in status:", error);
            return false;
        }
    }
</script>
