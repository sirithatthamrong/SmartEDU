<div class="max-w-2xl mx-auto p-6 bg-white rounded-lg shadow-md mt-10" data-turbo-permanent id="payment-wizard-container">
  <!-- Single progress bar -->
  <div class="flex mb-8 relative">
    <div class="flex-1 relative">
      <div class="w-8 h-8 bg-blue-500 text-white rounded-full mx-auto flex items-center justify-center border-2 border-blue-500">1</div>
      <p class="text-center text-xs mt-1">Personal</p>
    </div>
    <div class="flex-1 relative">
      <div class="w-8 h-8 bg-gray-200 text-gray-600 rounded-full mx-auto flex items-center justify-center border-2 border-gray-200">2</div>
      <p class="text-center text-xs mt-1">Amount</p>
    </div>
    <div class="flex-1 relative">
      <div class="w-8 h-8 bg-gray-200 text-gray-600 rounded-full mx-auto flex items-center justify-center border-2 border-gray-200">3</div>
      <p class="text-center text-xs mt-1">Payment</p>
    </div>
    <div class="flex-1 relative">
      <div class="w-8 h-8 bg-gray-200 text-gray-600 rounded-full mx-auto flex items-center justify-center border-2 border-gray-200">4</div>
      <p class="text-center text-xs mt-1">Review</p>
    </div>
    <!-- Line connecting steps -->
    <div class="absolute top-4 left-0 w-full h-0.5 bg-gray-200 -z-10"></div>
  </div>

  <!-- Steps content -->
  <div id="payment-form-wizard">
    <!-- Step 1: Personal Information -->
    <div class="block py-5" id="step-1">
      <h2 class="text-2xl font-bold mb-6">Personal Information</h2>
      <div class="mb-5">
        <label for="first_name" class="block mb-2 font-medium">First Name</label>
        <input type="text" id="first_name" name="first_name" class="w-full p-3 border border-gray-300 rounded-md" required>
      </div>
      <div class="mb-5">
        <label for="last_name" class="block mb-2 font-medium">Last Name</label>
        <input type="text" id="last_name" name="last_name" class="w-full p-3 border border-gray-300 rounded-md" required>
      </div>
      <div class="flex justify-end mt-8">
        <button type="button" id="next-to-2" class="py-3 px-5 bg-blue-500 text-white rounded-md font-semibold">Next</button>
      </div>
    </div>

    <!-- Step 2: Amount -->
    <div class="hidden py-5" id="step-2">
      <h2 class="text-2xl font-bold mb-6">Payment Amount</h2>
      <div class="mb-5">
        <label for="amount" class="block mb-2 font-medium">Amount (in cents)</label>
        <input type="number" id="amount" name="amount" class="w-full p-3 border border-gray-300 rounded-md" min="1" required>
      </div>
      <div class="flex justify-between mt-8">
        <button type="button" id="prev-to-1" class="py-3 px-5 bg-gray-100 text-gray-700 rounded-md font-semibold">Back</button>
        <button type="button" id="next-to-3" class="py-3 px-5 bg-blue-500 text-white rounded-md font-semibold">Next</button>
      </div>
    </div>

    <!-- Step 3: Payment Method -->
    <div class="hidden py-5" id="step-3">
      <h2 class="text-2xl font-bold mb-6">Payment Method</h2>
      <div class="mb-5">
        <label for="card-element" class="block mb-2 font-medium">Credit or debit card</label>
        <div id="card-element" class="w-full p-3 border border-gray-300 rounded-md"></div>
        <div id="card-errors" class="text-red-500 mt-1 text-sm"></div>
      </div>
      <div class="flex justify-between mt-8">
        <button type="button" id="prev-to-2" class="py-3 px-5 bg-gray-100 text-gray-700 rounded-md font-semibold">Back</button>
        <button type="button" id="next-to-4" class="py-3 px-5 bg-blue-500 text-white rounded-md font-semibold">Next</button>
      </div>
    </div>

    <!-- Step 4: Review -->
    <div class="hidden py-5" id="step-4">
      <h2 class="text-2xl font-bold mb-6">Review Your Information</h2>
      <div class="bg-gray-50 p-4 rounded-lg mb-6">
        <div class="mb-5 border-b border-gray-100 pb-3">
          <h3 class="text-lg font-semibold mb-2">Personal Information</h3>
          <p><strong>Name:</strong> <span id="review-name" class="ml-2"></span></p>
        </div>
        <div class="mb-5 border-b border-gray-100 pb-3">
          <h3 class="text-lg font-semibold mb-2">Amount</h3>
          <p><strong>Total:</strong> <span class="ml-2">$<span id="review-amount"></span></span></p>
        </div>
        <div class="mb-5 border-b border-gray-100 pb-3">
          <h3 class="text-lg font-semibold mb-2">Payment Method</h3>
          <p>Credit Card <span id="review-card-last4" class="font-mono"></span>)</p>
        </div>
      </div>
      <div class="flex justify-between mt-8">
        <button type="button" id="prev-to-3" class="py-3 px-5 bg-gray-100 text-gray-700 rounded-md font-semibold">Back</button>
        <button type="button" id="submit-payment" class="py-3 px-5 bg-green-500 text-white rounded-md font-semibold">Complete Payment</button>
      </div>
    </div>
  </div>
</div>

<%= javascript_include_tag "https://js.stripe.com/v3/", "data-turbo-track": "reload" %>

<script data-turbo-track="reload">
    document.addEventListener("DOMContentLoaded", function() {
        console.log("Payment form script loaded");

        // Step navigation listeners
        document.getElementById('next-to-2').addEventListener('click', function() {
            validateAndGoToStep(1, 2);
        });

        document.getElementById('prev-to-1').addEventListener('click', function() {
            goToStep(1);
        });

        document.getElementById('next-to-3').addEventListener('click', function() {
            validateAndGoToStep(2, 3);
        });

        document.getElementById('prev-to-2').addEventListener('click', function() {
            goToStep(2);
        });

        document.getElementById('next-to-4').addEventListener('click', function() {
            validateAndGoToStep(3, 4);
        });

        document.getElementById('prev-to-3').addEventListener('click', function() {
            goToStep(3);
        });

        // Initialize Stripe on step 3 and variables for tracking progress
        let currentStep = 1;
        let stripe = null;
        let card = null;
        let cardComplete = false;
        let last4 = null;

        function validateAndGoToStep(currentStep, nextStep) {
            if (validateStep(currentStep)) {
                if (nextStep === 4) {
                    updateReviewInformation();
                }
                goToStep(nextStep);
            }
        }

        function goToStep(stepNumber) {
            // Hide all steps
            document.querySelectorAll('#payment-form-wizard > div').forEach(step => {
                step.classList.add('hidden');
                step.classList.remove('block');
            });

            // Show the target step
            document.getElementById(`step-${stepNumber}`).classList.add('block');
            document.getElementById(`step-${stepNumber}`).classList.remove('hidden');

            // Update progress bar indicators
            updateProgressBar(stepNumber);

            // Initialize Stripe if going to step 3
            if (stepNumber === 3) {
                initializeStripe();
            }

            currentStep = stepNumber;
        }

        function updateProgressBar(stepNumber) {
            // Reset all step indicators
            const stepIndicators = document.querySelectorAll('#payment-wizard-container .flex-1 > div:first-child');
            stepIndicators.forEach((indicator, index) => {
                if (index + 1 < stepNumber) {
                    indicator.classList.remove('bg-gray-200', 'text-gray-600', 'bg-blue-500', 'text-white');
                    indicator.classList.add('bg-green-500', 'text-white', 'border-green-500');
                } else if (index + 1 === stepNumber) {
                    indicator.classList.remove('bg-gray-200', 'text-gray-600', 'bg-green-500');
                    indicator.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
                } else {
                    indicator.classList.remove('bg-blue-500', 'text-white', 'bg-green-500', 'border-green-500', 'border-blue-500');
                    indicator.classList.add('bg-gray-200', 'text-gray-600', 'border-gray-200');
                }
            });
        }

        function validateStep(step) {
            switch(step) {
                case 1:
                    const firstName = document.getElementById('first_name').value;
                    const lastName = document.getElementById('last_name').value;
                    if (!firstName || !lastName) {
                        alert('Please fill in all required fields');
                        return false;
                    }
                    return true;
                case 2:
                    const amount = document.getElementById('amount').value;
                    if (!amount || amount <= 0) {
                        alert('Please enter a valid amount');
                        return false;
                    }
                    return true;
                case 3:
                    if (!cardComplete) {
                        alert('Please complete the card information');
                        return false;
                    }
                    return true;
                default:
                    return true;
            }
        }

        function initializeStripe() {
            const cardElement = document.getElementById('card-element');
            if (!cardElement) return;

            if (!stripe) {
                stripe = Stripe("<%= Rails.application.credentials.dig(:stripe, :publishable_key) %>");
            }

            if (card) {
                card.destroy();
            }

            const elements = stripe.elements();
            card = elements.create("card");
            card.mount("#card-element");

            card.addEventListener('change', (event) => {
                const displayError = document.getElementById('card-errors');
                if (event.error) {
                    displayError.textContent = event.error.message;
                    cardComplete = false;
                } else {
                    displayError.textContent = '';
                    cardComplete = event.complete;
                    if (event.complete && event.value?.card?.last4) {
                        last4 = event.value.card.last4;
                        console.log(last4);
                    }
                }
            });
        }

        function updateReviewInformation() {
            const firstName = document.getElementById('first_name').value;
            const lastName = document.getElementById('last_name').value;
            const amount = document.getElementById('amount').value;

            document.getElementById('review-name').textContent = `${firstName} ${lastName}`;
            document.getElementById('review-amount').textContent = (amount / 100).toFixed(2);

            if (last4) {
                document.getElementById('review-card-last4').textContent = "****" + last4;
            }
        }

        // Handle payment form submission
        document.getElementById('submit-payment').addEventListener('click', async function() {
            const firstName = document.getElementById('first_name').value;
            const lastName = document.getElementById('last_name').value;
            const amount = document.getElementById('amount').value;

            const submitButton = document.getElementById('submit-payment');
            submitButton.disabled = true;
            submitButton.textContent = 'Processing...';

            try {
                const {paymentMethod, error} = await stripe.createPaymentMethod({
                    type: "card",
                    card: card,
                    billing_details: {
                        name: `${firstName} ${lastName}`,
                    }
                });

                if (error) {
                    alert(error.message);
                    submitButton.disabled = false;
                    submitButton.textContent = 'Complete Payment';
                    return;
                }

                const response = await fetch("/payments", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRF-Token": "<%= form_authenticity_token %>"
                    },
                    body: JSON.stringify({
                        first_name: firstName,
                        last_name: lastName,
                        amount: parseInt(amount),
                        payment_method_id: paymentMethod.id
                    }),
                });

                if (response.ok) {
                    window.location.href = "/payments/success";
                } else {
                    alert("Payment failed!");
                    submitButton.disabled = false;
                    submitButton.textContent = 'Complete Payment';
                }
            } catch (e) {
                alert("An unexpected error occurred: " + e.message);
                submitButton.disabled = false;
                submitButton.textContent = 'Complete Payment';
            }
        });
    });
</script>
